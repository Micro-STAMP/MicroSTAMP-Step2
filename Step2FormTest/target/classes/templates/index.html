<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="ISO-8859-1">
    <title>Home</title>

    <link th:rel="stylesheet" th:href="@{assets/jquery-treetable/jquery.treetable.css}"/>
    <link th:rel="stylesheet" th:href="@{assets/jquery-treetable/jquery.treetable.theme.default.css}"/>
    <link th:rel="stylesheet" th:href="@{webjars/bootstrap/4.0.0-2/css/bootstrap.min.css} "/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
</head>
<body>
    <div class="container" align="Left" style="margin-left: 2em;">
        <h1 style="margin-top: 0.5cm;">MicroSTAMP Step 2</h1>
        <br/>
        <div align="Left">
            <div class="container" style="margin-left: 2%;">
                <h2 style="display : inline-block;">Components</h2>
                <button id="collapseAllComponentsButton" style="display : inline-block; vertical-align : top; float : right;" type="button" class="btn btn-primary" onclick=collapseAllComponents()>Collapse All</button>
                <div th:switch="${components.size}">
                    <h5 th:case='1'>No components yet!</h5>
                    <div th:case="*">
                        <div class="row">
                            <div class="col mt-5">
                                <table id="treeTable" class="table">
                                    <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Border</th>
                                        <th>is visible?</th>
                                        <th>Type</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <div class="container" style="margin-left: 2%;">
                <h2 style="display : inline-block;">Connections</h2>
                <button id="collapseAllConnectionsButton" style="display : inline-block; vertical-align : top; float : right;" type="button" class="btn btn-primary" onclick=collapseAllConnections()>Collapse All</button>
                <div th:switch="${connections.size}">
                    <h5 th:case='0'>No connections yet!</h5>
                    <div th:case="*">
                        <div class="row">
                            <div class="col mt-5">
                                <table id="connectionTable" class="table">
                                    <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th>Target</th>
                                        <th>Connection Type</th>
                                        <th>Style</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" id="control_structure_id" th:value="${control_structure_id}"/>
            <br/>
        </div>
        <br/>
        <div>
            <div align="Left">

                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addComponentModal" >Add Component</button>

                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addConnectionModal" >Add Connection</button>

                <a th:href="@{/home}" style="float: right;">
                    <input type="button" class="btn btn-secondary" value="Return"/>
                </a>
            </div>

            <br/>

            <button type="button" class="btn btn-primary" onclick=uploadImage()>Upload Image</button>

            <input type="file" name="image" accept="image/png, image/jpeg" id="image"/>

            <div th:each="image : ${images}">
                <img th:src="@{/cs-images/{control_structure_id}/{imageName}(control_structure_id = ${control_structure_id}, imageName = ${image.name})}">
            </div>

            <!--<img src="/cs-images/1/TesteImagem.png"/>-->
        </div>
    </div>

<div class="modal fade" id="addComponentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addComponentLabel">Add Component</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="component-name" class="col-form-label">Name:</label>
                        <input type="text" class="form-control" id="component-name">
                    </div>
                    <div class="form-group">
                        <label for="component-type" class="col-form-label">Type:</label>
                        <select class="form-control" id="component-type">
                            <option value="controller">Controller</option>
                            <option value="controlledProcess">Controlled Process</option>
                            <option value="actuator">Actuator</option>
                            <option value="sensor">Sensor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="component-border" class="col-form-label">Border:</label>
                        <select class="form-control" id="component-border">
                            <option th:each="p : ${style}" th:value="${p}" th:text="${p}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="component-father" class="col-form-label">Father:</label>
                        <select class="form-control" id="component-father">
                            <option value="null">NO FATHER</option>
                            <option th:each="p : ${componentsWithoutEnvironment}" th:value="${p.id}" th:text="${p.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">is visible? </label>
                        <input type="radio" id="isVisible" name="visible" value="true" style="margin-left: 5%;" checked>
                        <label class="col-form-label" for="isVisible">True</label>
                        <input type="radio" id="isNotVisible" name="visible" value="false" style="margin-left: 5%;">
                        <label class="col-form-label" for="isNotVisible">False</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick=addComponent()>Add Component</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addConnectionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addConnectionLabel">Add Connection</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="connection-source" class="col-form-label">Source:</label>
                        <select class="form-control" id="connection-source">
                            <option th:each="s : ${components}" th:value="${s.id}" th:text="${s.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-target" class="col-form-label">Target:</label>
                        <select class="form-control" id="connection-target">
                            <option th:each="t : ${components}" th:value="${t.id}" th:text="${t.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-type" class="col-form-label">Connection Type:</label>
                        <select class="form-control" id="connection-type">
                            <option th:each="p : ${connectionType}" th:value="${p}" th:text="${p}" />
                        </select>
                        <select class="form-control" id="connection-type-pi">
                            <option th:each="pi : ${process_input}" th:value="${pi}" th:text="${pi}"/>
                        </select>
                        <select class="form-control" id="connection-type-po" disabled>
                            <option th:value="${process_output}" th:text="${process_output}" selected/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-style" class="col-form-label">Style:</label>
                        <select class="form-control" id="connection-style">
                            <option th:each="p : ${style}" th:value="${p}" th:text="${p}"/>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick=addConnection()>Add Connection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editComponentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editComponentLabel">Edit Component</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="component-edit-name" class="col-form-label">Name:</label>
                        <input type="text" class="form-control" id="component-edit-name">
                    </div>
                    <div class="form-group">
                        <label for="component-edit-type" class="col-form-label">Type:</label>
                        <select class="form-control" id="component-edit-type">
                            <option value="controller">Controller</option>
                            <option value="controlledProcess">Controlled Process</option>
                            <option value="actuator">Actuator</option>
                            <option value="sensor">Sensor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="component-edit-border" class="col-form-label">Border:</label>
                        <select class="form-control" id="component-edit-border">
                            <option th:each="p : ${style}" th:value="${p}" th:text="${p}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="component-edit-father" class="col-form-label">Father:</label>
                        <select class="form-control" id="component-edit-father">
                            <option value="null">NO FATHER</option>
                            <option th:each="p : ${componentsWithoutEnvironment}" th:value="${p.id}" th:text="${p.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="col-form-label">is visible? </label>
                        <input type="radio" id="editIsVisible" name="visible" value="true" style="margin-left: 5%;" checked>
                        <label class="col-form-label" for="isVisible">True</label>
                        <input type="radio" id="editIsNotVisible" name="visible" value="false" style="margin-left: 5%;">
                        <label class="col-form-label" for="isNotVisible">False</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick=sendEditedComponent()>Edit Component</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editConnectionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editConnectionLabel">Edit Connection</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick=unwrapLast()>
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="connection-edit-source" class="col-form-label">Source:</label>
                        <select class="form-control" id="connection-edit-source">
                            <option th:each="s : ${components}" th:value="${s.id}" th:text="${s.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-edit-target" class="col-form-label">Target:</label>
                        <select class="form-control" id="connection-edit-target">
                            <option th:each="t : ${components}" th:value="${t.id}" th:text="${t.name}"/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-edit-type" class="col-form-label">Connection Type:</label>
                        <select class="form-control" id="connection-edit-type">
                            <option th:each="p : ${connectionType}" th:value="${p}" th:text="${p}" />
                        </select>
                        <select class="form-control" id="connection-edit-type-pi">
                            <option th:each="pi : ${process_input}" th:value="${pi}" th:text="${pi}"/>
                        </select>
                        <select class="form-control" id="connection-edit-type-po" disabled>
                            <option th:value="${process_output}" th:text="${process_output}" selected/>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="connection-edit-style" class="col-form-label">Style:</label>
                        <select class="form-control" id="connection-edit-style">
                            <option th:each="p : ${style}" th:value="${p}" th:text="${p}"/>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick=unwrapLast()>Close</button>
                <button type="button" class="btn btn-primary" onclick=sendEditedConnection()>Edit Connection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmComponentDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Component</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete
                <span id="componentToBeDeletedName"></span>
                ?
                <br/>
                <span id="itemsToBeDeletedSpan">The following items will be deleted as well:</span>
                <ul id="itemsToBeDeleted">
                    <li id="componentsToBeDeletedLi">Components</li>
                    <ul id="componentsToBeDeleted">
                    </ul>
                    <li id="connectionsToBeDeletedLi">Connections</li>
                    <ul id="connectionsToBeDeleted">
                    </ul>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick = deleteComponent()>Delete Component</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmConnectionDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Connection</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the following connection ?
                <br/><br/>
                <span id="connectionToBeDeletedType"></span>
                <br/>
                <span id="connectionToBeDeletedSourceName"></span>
                --->
                <span id="connectionToBeDeletedTargetName"></span>
                <br/>
                <ul id="labelsToBeDeleted"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick = deleteConnection()>Delete Connection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addLabelModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Label</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="label-name" class="col-form-label">Label:</label>
                        <input type="text" class="form-control" id="label-name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick=addLabel()>Add Label</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editLabelModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Label</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="label-edit-name" class="col-form-label">Label:</label>
                        <input type="text" class="form-control" id="label-edit-name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick=editLabel()>Edit Label</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmLabelDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Label</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete the following Label ?
                <br/><br/>
                <span id="label_delete_name"></span>
                <br/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick = deleteLabel()>Delete Label</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="environmentRestrictionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exception</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick=returnEnvironmentRestriction()>
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Exception: can't create a Component named "Environment" !
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick=returnEnvironmentRestriction()>Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="namelessRestrictionModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Exception</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick=returnNamelessRestriction()>
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Exception: can't create a Component without a name !
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick=returnNamelessRestriction()>Close</button>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script th:src="@{/webjars/popper.js/umd/popper.min.js}"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script th:src="@{/webjars/bootstrap/js/bootstrap.min.js}"></script>

<script type="text/javascript">

    var componentSelected;
    var componentSelectedOriginalType;
    var componentToBeDeleted;
    var connectionSelected;
    var connectionToBeDeleted;
    var connectionToBeLabeled;
    var labelToBeEdited;
    var labelToBeDeleted;
    var wrapped = false;
    var actual_modal; // 0 -> addComponent 1 -> editComponent //control the restrictions return

    $(window).ready(function () {
        var cs_id = $("#control_structure_id").val();
        $.ajax({
            "type": 'get',
            "url": '/components/' + cs_id,
            "dataType": "json",
            "success": function (data) {
                var backup = data;
                $.each(data, function (idx, obj) {
                    if(obj.father == null && obj.name != "Environment"){
                        $("#treeTable").append("<tr data-tt-id=\"" + obj.id + "\" data-tt-parent-id=\"" + obj.father + "\"><td>" + obj.name + "</td><td>" + obj.border + "</td><td>" + obj.isVisible + "</td><td>" + obj.type + "</td><td><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#editComponentModal' onclick = editComponent(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-pencil' aria-hidden='true'></span></button><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#confirmComponentDeleteModal' onclick = loadComponentsAndConnectionsToBeDeleted(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-trash'></span></button></td></tr>");
                        addChildren(obj.id,backup);
                    }
                });
                $("#treeTable").treetable({
                    expandable: true,
                    initialState: "expanded",
                    clickableNodeNames: true,
                    indent: 30
                });
            }
        });
        $.ajax({
            "type": 'get',
            "url": '/connections/' + cs_id,
            "dataType": "json",
            "success": function (data) {
                $.each(data, function (idx, obj) {
                    $("#connectionTable").append("<tr data-tt-id=\"" + obj.id + "\" data-tt-parent-id=\"" + obj.father + "\"><td>" + obj.sourceName + "</td><td>" + obj.targetName + "</td><td>" + obj.connectionType + "</td><td>" + obj.style + "</td><td><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#editConnectionModal' onclick = editConnection(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-pencil' aria-hidden='true'></span></button><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#confirmConnectionDeleteModal' onclick = loadConnectionToBeDeleted(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-trash'></span></button><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#addLabelModal' onclick = loadConnectionToBeLabeled(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-plus'></span></button></td></tr>");
                    $.each(obj.labels, function (idx, label) {
                        $("#connectionTable").append("<tr data-tt-id=\"" + label.id + "\" data-tt-parent-id=\"" + obj.id + "\"><td>" + label.label + "</td><td>" + " " + "</td><td>" + " " + "</td><td>" + "LABEL" + "</td><td><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#editLabelModal' onclick = loadLabelToBeEdited(this.id) type='button' id=\"" + label.id + "\"><span class='fa fa-pencil' aria-hidden='true'></span></button><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#confirmLabelDeleteModal' onclick = loadLabelToBeDeleted(this.id) type='button' id=\"" + label.id + "\"><span class='fa fa-trash'></span></button></td></tr>");
                    });
                });
                $("#connectionTable").treetable({
                    expandable: true,
                    initialState: "expanded",
                    clickableNodeNames: true,
                    indent: 30
                });
            }
        });
    });

    var previous;
    var previous_edit;

    $(window).on('load', function() {
        previous = $("#connection-source").val();
        $("#connection-target option[value="+previous+"]").wrap('<span/>');
        if($("#connection-source option[value="+previous+"]").text() == "Environment"){
            $("#connection-type-pi").css("display","");
            $("#connection-type-po").css("display","none");
            $("#connection-type").css("display","none");
        }
    });

    $("#connection-source").on('change',function(){
        conn_target_value = $("#connection-target").val();
        if($("#connection-source option[value="+this.value+"]").text() == "Environment"){
            $("#connection-type-pi").css("display","");
            $("#connection-type-po").css("display","none");
            $("#connection-type").css("display","none");
        }else if($("#connection-target option[value="+conn_target_value+"]").text() == "Environment"){
            $("#connection-type-po").css("display","");
            $("#connection-type-pi").css("display","none");
            $("#connection-type").css("display","none");
        }else{
            $("#connection-type-po").css("display","none");
            $("#connection-type-pi").css("display","none");
            $("#connection-type").css("display","");
            $("#connection-type").val("CONTROL_ACTION");
        }
    });

    $("#connection-edit-source").on('change',function(){
        conn_target_value = $("#connection-edit-target").val();
        if($("#connection-edit-source option[value="+this.value+"]").text() == "Environment"){
            $("#connection-edit-type-pi").css("display","");
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type").css("display","none");
        }else if($("#connection-edit-target option[value="+conn_target_value+"]").text() == "Environment"){
            $("#connection-edit-type-po").css("display","");
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type").css("display","none");
        }else{
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type").css("display","");
            $("#connection-edit-type").val("CONTROL_ACTION");
        }
    });


    $("#connection-target").on('change',function(){
        conn_source_value = $("#connection-source").val();
        if($("#connection-target option[value="+this.value+"]").text() == "Environment"){
            $("#connection-type-pi").css("display","none");
            $("#connection-type-po").css("display","");
            $("#connection-type").css("display","none");
        }else if($("#connection-source option[value="+conn_source_value+"]").text() == "Environment"){
            $("#connection-type-po").css("display","none");
            $("#connection-type-pi").css("display","");
            $("#connection-type").css("display","none");
        }else{
            $("#connection-type-po").css("display","none");
            $("#connection-type-pi").css("display","none");
            $("#connection-type").css("display","");
            $("#connection-type").val("CONTROL_ACTION");
        }
    });

    $("#connection-edit-target").on('change',function(){
        conn_source_value = $("#connection-edit-source").val();
        if($("#connection-edit-target option[value="+this.value+"]").text() == "Environment"){
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type-po").css("display","");
            $("#connection-edit-type").css("display","none");
        }else if($("#connection-edit-source option[value="+conn_source_value+"]").text() == "Environment"){
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type-pi").css("display","");
            $("#connection-edit-type").css("display","none");
        }else{
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type").css("display","");
            $("#connection-edit-type").val("CONTROL_ACTION");
        }
    });


    $("#connection-source").on('focus', function () {
        previous = this.value;
    }).change(function() {
        var selected = this.value;
        $("#connection-target option[value="+selected+"]").wrap('<span/>');
        $("#connection-target option[value="+previous+"]").unwrap();
        previous = this.value;

        conn_target_value = $("#connection-target").val();
        if($("#connection-source option[value="+this.value+"]").text() == "Environment"){
            $("#connection-type-pi").css("display","");
            $("#connection-type-po").css("display","none");
            $("#connection-type").css("display","none");
        }else if($("#connection-target option[value="+conn_target_value+"]").text() == "Environment"){
            $("#connection-type-po").css("display","");
            $("#connection-type-pi").css("display","none");
            $("#connection-type").css("display","none");
        }else{
            $("#connection-type-po").css("display","none");
            $("#connection-type-pi").css("display","none");
            $("#connection-type").css("display","");
            $("#connection-type").val("CONTROL_ACTION");
        }
    });

    $("#connection-edit-source").on('focus', function () {
        previous_edit = this.value;
    }).change(function() {
        var selected = this.value;
        $("#connection-edit-target option[value="+selected+"]").wrap('<span/>');
        $("#connection-edit-target option[value="+previous_edit+"]").unwrap();
        previous_edit = this.value;

        conn_target_value = $("#connection-edit-target").val();
        if($("#connection-edit-source option[value="+this.value+"]").text() == "Environment"){
            $("#connection-edit-type-pi").css("display","");
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type").css("display","none");
        }else if($("#connection-edit-target option[value="+conn_target_value+"]").text() == "Environment"){
            $("#connection-edit-type-po").css("display","");
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type").css("display","none");
        }else{
            $("#connection-edit-type-po").css("display","none");
            $("#connection-edit-type-pi").css("display","none");
            $("#connection-edit-type").css("display","");
            $("#connection-edit-type").val("CONTROL_ACTION");
        }
    });

    $("#component-edit-father").on('focus', function () {
        $("#component-edit-father option[value="+componentSelected+"]").wrap('<span/>');
    });

    $("#component-edit-father").on('focusout', function () {
        $("#component-edit-father option[value="+componentSelected+"]").unwrap();
    });

    function addChildren(id, backup){
       $.each(backup, function (idx, obj) {
            if(obj.father != null){
                if(obj.father.id == id){
                    $("#treeTable").append("<tr data-tt-id=\"" + obj.id + "\" data-tt-parent-id=\"" + obj.father.id + "\"><td>" + obj.name + "</td><td>" + obj.border + "</td><td>" + obj.isVisible + "</td><td>" + obj.type + "</td><td><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#editComponentModal' onclick = editComponent(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-pencil' aria-hidden='true'></span></button><button style='cursor: pointer; border-radius: 5px;' data-toggle='modal' data-target='#confirmComponentDeleteModal' onclick = loadComponentsAndConnectionsToBeDeleted(this.id) type='button' id=\"" + obj.id + "\"><span class='fa fa-trash'></span></button></td></tr>");
                    addChildren(obj.id,backup);
                }
            }
       });
    }

    function addComponent(){
        if(document.getElementById('isVisible').checked) {
            var checkedValue = new Boolean(1);
        }else{
            var checkedValue = new Boolean(0);
        }

        var component = {
            name: $("#component-name").val(),
            father_id: $("#component-father").val(),
            border: $("#component-border").val(),
            isVisible: checkedValue,
            control_structure_id: $("#control_structure_id").val(),
        }

        if($("#component-type").val() == "controlledProcess")
            var componentType = $("#component-type").val() + "es";
        else var componentType = $("#component-type").val() + "s";

        if($("#component-name").val() == "Environment"){
            $("#addComponentModal").modal("hide");
            actual_modal = 0;
            $("#environmentRestrictionModal").modal("show");
        }else if($("#component-name").val() == ""){
            $("#addComponentModal").modal("hide");
            actual_modal = 0;
            $("#namelessRestrictionModal").modal("show");
        }else{
            $.ajax({
                url: '/'+ componentType,
                type: 'post',
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    location.reload();
                },
                data: JSON.stringify(component)
            });
        }
    }

    function returnEnvironmentRestriction(){
        $("#environmentRestrictionModal").modal("hide");
        if(actual_modal == 0)
            $("#addComponentModal").modal("show");
        else
            $("#editComponentModal").modal("show");
    }

    function returnNamelessRestriction(){
        $("#namelessRestrictionModal").modal("hide");
        if(actual_modal == 0)
            $("#addComponentModal").modal("show");
        else
            $("#editComponentModal").modal("show");
    }

    function addConnection() {
        var connType;

        if($("#connection-type-pi").css("display") == "none" && $("#connection-type-po").css("display") == "none"){
            connType = $("#connection-type").val();
        }else if($("#connection-type-pi").css("display") == "none" && $("#connection-type").css("display") == "none"){
            connType = $("#connection-type-po").val();
        }else{
            connType = $("#connection-type-pi").val();
        }

        var connection = {
            source_id: $("#connection-source").val(),
            target_id: $("#connection-target").val(),
            connectionType: connType,
            style: $("#connection-style").val(),
            control_structure_id: $("#control_structure_id").val(),
        }

        $('#target').html('sending..');

        $.ajax({
            url: '/connections',
            type: 'post',
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
                location.reload();
            },
            data: JSON.stringify(connection)
        });
    }

    function editComponent(id){
        componentSelected = id;
        $.ajax({
            url: '/components/listComponents/'+ id,
            type: 'get',
            success: function (data) {
                $("#component-edit-name").val(data.name);
                switch(data.type){
                    case "Controller":
                        $("#component-edit-type").val("controller");
                        break;
                    case "Actuator":
                        $("#component-edit-type").val("actuator");
                        break;
                    case "Sensor":
                        $("#component-edit-type").val("sensor");
                        break;
                    case "ControlledProcess":
                        $("#component-edit-type").val("controlledProcess");
                        break;
                }
                $("#component-edit-border").val(data.border);
                if(data.father == null)
                    $("#component-edit-father").val("null");
                else
                    $("#component-edit-father").val(data.father.id);
                if(data.isVisible == true)
                    $("#editIsVisible").prop("checked", true);
                else
                    $("#editIsNotVisible").prop("checked", true);

                componentSelectedOriginalType = $("#component-edit-type").val();
            },
        });
    }

    function sendEditedComponent(){
        if(document.getElementById('editIsVisible').checked) {
            var checkedValue = new Boolean(1);
        }else{
            var checkedValue = new Boolean(0);
        }

        var type = $("#component-edit-type").val();
        type = type.charAt(0).toUpperCase() + type.slice(1);

        var component = {
            name: $("#component-edit-name").val(),
            father_id: $("#component-edit-father").val(),
            border: $("#component-edit-border").val(),
            isVisible: checkedValue,
            control_structure_id: $("#control_structure_id").val(),
            type: type,
        }

        if(componentSelectedOriginalType == "controlledProcess")
            var componentType = componentSelectedOriginalType + "es";
        else var componentType = componentSelectedOriginalType + "s";

        if($("#component-edit-name").val() == "Environment"){
            $("#editComponentModal").modal("hide");
            actual_modal = 1;
            $("#environmentRestrictionModal").modal("show");
        }else if($("#component-edit-name").val() == ""){
            $("#editComponentModal").modal("hide");
            actual_modal = 1;
            $("#namelessRestrictionModal").modal("show");
        }else{
            console.log(component);
            $.ajax({
                url: '/'+ componentType + '/' + componentSelected,
                type: 'put',
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    location.reload();
                },
                data: JSON.stringify(component)
            });
        }
    }

    function editConnection(id){
        connectionSelected = id;

         $.ajax({
            url: '/connections/listConnections/'+ id,
            type: 'get',
            success: function (data) {

                if(data.connectionType == "PROCESS_INPUT" || data.connectionType == "DISTURBANCE"){
                    $("#connection-edit-type-pi").val(data.connectionType);
                }else if(data.connectionType == "PROCESS_OUTPUT"){
                    $("#connection-edit-type-po").val(data.connectionType);
                }else{
                    $("#connection-edit-type").val(data.connectionType);
                }

                $("#connection-edit-style").val(data.style);
                $("#connection-edit-source").val(data.source.id);
                $("#connection-edit-target").val(data.target.id);
                previous_edit = data.source.id;
                wrapFirst(previous_edit);

                var conn_target_value = data.target.id;
                var conn_source_value = data.source.id;

                if($("#connection-edit-source option[value="+conn_source_value+"]").text() == "Environment"){
                    $("#connection-edit-type-pi").css("display","");
                    $("#connection-edit-type-po").css("display","none");
                    $("#connection-edit-type").css("display","none");
                }else if($("#connection-edit-target option[value="+conn_target_value+"]").text() == "Environment"){
                    $("#connection-edit-type-po").css("display","");
                    $("#connection-edit-type-pi").css("display","none");
                    $("#connection-edit-type").css("display","none");
                }else{
                    $("#connection-edit-type-po").css("display","none");
                    $("#connection-edit-type-pi").css("display","none");
                    $("#connection-edit-type").css("display","");
                }
            },
        });
    }

    function wrapFirst(val){
        $("#connection-edit-target option[value="+val+"]").wrap('<span/>');
    }

    function unwrapLast(){
         $("#connection-edit-target option[value="+previous_edit+"]").unwrap();
    }

    function sendEditedConnection(){

        var connType;
        if($("#connection-edit-type-pi").css("display") == "none" && $("#connection-edit-type-po").css("display") == "none"){
            connType = $("#connection-edit-type").val();
        }else if($("#connection-edit-type-pi").css("display") == "none" && $("#connection-edit-type").css("display") == "none"){
            connType = $("#connection-edit-type-po").val();
        }else{
            connType = $("#connection-edit-type-pi").val();
        }

        var connection = {
            source_id: $("#connection-edit-source").val(),
            target_id: $("#connection-edit-target").val(),
            connectionType: connType,
            style: $("#connection-edit-style").val(),
            control_structure_id: $("#control_structure_id").val(),
        }

        $.ajax({
            url: '/connections/' + connectionSelected,
            type: 'put',
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
                location.reload();
            },
            data: JSON.stringify(connection)
        });
    }

    function loadComponentsAndConnectionsToBeDeleted(id){
        componentToBeDeleted = id;
        $("#itemsToBeDeleted").css("display","grid");
        $("#itemsToBeDeletedSpan").css("display","flex");
        $("#componentsToBeDeleted").css("display","grid");
        $("#connectionsToBeDeleted").css("display","grid");
        $("#componentsToBeDeletedLi").css("display","");
        $("#connectionsToBeDeletedLi").css("display","");

        $.ajax({
            url: '/components/listComponents/'+ id,
            type: 'get',
            success: function (data) {
                 $("#componentToBeDeletedName").text(data.name);
            },
        });

        $("#componentsToBeDeleted").empty();
        $("#connectionsToBeDeleted").empty();

        $.ajax({
            url: '/components/listComponentsAndConnectionsToBeDeleted/'+ id,
            type: 'get',
            success: function (data) {
                var numComp = 0;
                var numConn = 0;
                $.each(data, function (idx, obj) {
                    if(obj.name != null){
                        $("#componentsToBeDeleted").append("<li>" + obj.name + "</li>");
                        numComp++;
                    }else{
                        $("#connectionsToBeDeleted").append("<li>" + obj.source.name + " ---> " + obj.target.name + "</li>");
                        numConn++;
                    }
                });
                if((numComp == 0) && (numConn == 0)){
                    $("#itemsToBeDeleted").css("display","none");
                    $("#itemsToBeDeletedSpan").css("display","none");
                }else if(numComp == 0){
                    $("#componentsToBeDeleted").css("display","none");
                    $("#componentsToBeDeletedLi").css("display","none");
                }else if(numConn == 0){
                    $("#connectionsToBeDeleted").css("display","none");
                    $("#connectionsToBeDeletedLi").css("display","none");
                }
            },
        });
    }

    function deleteComponent(){
        $.ajax({
            url: '/components/'+ componentToBeDeleted,
            type: 'delete',
            success: function (data) {
                location.reload();
            },
        });
    }

    function loadConnectionToBeDeleted(id){
        connectionToBeDeleted = id;
        $.ajax({
            url: '/connections/listConnections/'+ id,
            type: 'get',
            success: function (data) {
                 $("#connectionToBeDeletedType").text(data.connectionType);
                 $("#connectionToBeDeletedSourceName").text(data.source.name);
                 $("#connectionToBeDeletedTargetName").text(data.target.name);
            },
        });
        $("#labelsToBeDeleted").empty();
        $.ajax({
            url: '/connections/listLabelsToBeDeleted/'+ id,
            type: 'get',
            success: function (data) {
                 $.each(data, function (idx, obj) {
                    $("#labelsToBeDeleted").append("<li>" + obj.label + "</li>");
                });
            },
        });
    }

    function deleteConnection(){
        $.ajax({
            url: '/connections/'+ connectionToBeDeleted,
            type: 'delete',
            success: function (data) {
                location.reload();
            },
        });
    }

    function uploadImage(){

        image = $("#image").val();
        var control_structure_id = $("#control_structure_id").val();
        var myFile = $('#image').prop('files');

        var data = new FormData();
        data.append('image',myFile[0]);

        $.ajax({
            url: '/images/' + control_structure_id,
            type: 'POST',
            cache: false,
            contentType: false,
            processData: false,
            success: function (data) {
                location.reload();
            },
            data:data
        });
    }

    function loadConnectionToBeLabeled(id){
        connectionToBeLabeled = id;
    }

    function addLabel(){
        var label = {
            label: $("#label-name").val(),
            connection_id: connectionToBeLabeled,
        }

        $.ajax({
            url: '/labels',
            type: 'post',
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
                location.reload();
            },
            data: JSON.stringify(label)
        });
    }

    function loadLabelToBeEdited(id){
        labelToBeEdited = id;
        $.ajax({
            url: '/labels/'+ id,
            type: 'get',
            success: function (data) {
                $("#label-edit-name").val(data.label);
            },
        });
    }

    function editLabel() {
        var label = {
            label: $("#label-edit-name").val(),
        }

        $.ajax({
            url: '/labels/' + labelToBeEdited,
            type: 'put',
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
                location.reload();
            },
            data: JSON.stringify(label)
        });
    }

    function loadLabelToBeDeleted(id){
        labelToBeDeleted = id;
        $.ajax({
                url: '/labels/'+ id,
                type: 'get',
                success: function (data) {
                     $("#label_delete_name").text(data.label);
                },
            });
    }

    function deleteLabel(){
        $.ajax({
            url: '/labels/'+ labelToBeDeleted,
            type: 'delete',
            success: function (data) {
                location.reload();
            },
        });
    }

    function collapseAllComponents(){
        $("#collapseAllComponentsButton").attr("onclick","expandAllComponents()");
        $("#collapseAllComponentsButton").text("Expand All");
        $("#treeTable").treetable("collapseAll");
    }

    function expandAllComponents(){
        $("#collapseAllComponentsButton").attr("onclick","collapseAllComponents()");
        $("#collapseAllComponentsButton").text("Collapse All");
        $("#treeTable").treetable("expandAll");
    }

    function collapseAllConnections(){
        $("#collapseAllConnectionsButton").attr("onclick","expandAllConnections()");
        $("#collapseAllConnectionsButton").text("Expand All");
        $("#connectionTable").treetable("collapseAll");
    }

    function expandAllConnections(){
        $("#collapseAllConnectionsButton").attr("onclick","collapseAllConnections()");
        $("#collapseAllConnectionsButton").text("Collapse All");
        $("#connectionTable").treetable("expandAll");
    }

</script>
<script src="/assets/jquery-treetable/jquery.treetable.js"></script>
</body>
</html>